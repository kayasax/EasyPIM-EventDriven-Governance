name: 'Phase 1: Authentication Test - EasyPIM CI/CD'

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Authentication test mode'
        required: false
        default: 'standard'
        type: choice
        options:
          - standard
          - verbose

env:
  KEYVAULT_NAME: ${{ vars.AZURE_KEYVAULT_NAME }}
  SECRET_NAME: ${{ vars.AZURE_KEYVAULT_SECRET_NAME }}
  TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}

permissions:
  id-token: write   # for OIDC
  contents: read

jobs:
  authentication-test:
    name: 'Authentication & Module Verification'
    runs-on: ubuntu-latest

    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      - name: 'Azure OIDC Login'
        uses: azure/login@v2
        with:
          tenant-id: ${{ env.TENANT_ID }}
          subscription-id: ${{ env.SUBSCRIPTION_ID }}
          client-id: ${{ env.AZURE_CLIENT_ID }}

      - name: 'Verify Azure CLI Version'
        run: az version

      - name: 'Phase 1 Authentication Test (Per Step 4.2)'
        shell: pwsh
        run: |
          Write-Host "ðŸ” Phase 1: Authentication Test - Per Step 4.2 Guidelines"
          Write-Host "============================================================"
          Write-Host ""

          # Test 1: EasyPIM Module Installation
          Write-Host "ðŸš€ Test 1: Installing EasyPIM modules from PowerShell Gallery..."
          try {
              Install-Module -Name EasyPIM -Force -Scope CurrentUser -Verbose
              Install-Module -Name EasyPIM.Orchestrator -Force -Scope CurrentUser -Verbose
              Write-Host "âœ… EasyPIM modules installed successfully"
          }
          catch {
              Write-Error "âŒ Failed to install EasyPIM modules: $_"
              throw
          }

          # Test 2: Module Import
          Write-Host ""
          Write-Host "ðŸ“¦ Test 2: Importing EasyPIM.Orchestrator module..."
          try {
              Import-Module EasyPIM.Orchestrator -Force -Verbose
              Write-Host "âœ… EasyPIM modules imported successfully"
          }
          catch {
              Write-Error "âŒ Failed to import EasyPIM modules: $_"
              throw
          }

          # Test 3: Key Vault Access (only if Key Vault name is provided)
          Write-Host ""
          Write-Host "ðŸ”‘ Test 3: Verifying Key Vault access..."
          Write-Host "   Key Vault: $env:KEYVAULT_NAME"
          Write-Host "   Secret Name: $env:SECRET_NAME"

          if (-not $env:KEYVAULT_NAME) {
              Write-Warning "âš ï¸  AZURE_KEY_VAULT_NAME secret not configured"
              Write-Host "   Skipping Key Vault test - configure GitHub secret first"
          } else {
              try {
                  $configContent = az keyvault secret show --vault-name $env:KEYVAULT_NAME --name $env:SECRET_NAME --query "value" -o tsv
                  if ($configContent) {
                      $config = $configContent | ConvertFrom-Json
                      Write-Host "âœ… Key Vault access confirmed"
                      Write-Host "âœ… Configuration retrieved successfully"
                      Write-Host "   Protected Users: $($config.ProtectedUsers.Count) configured"
                      if ($config.PolicyTemplates) {
                          Write-Host "   Policy Templates: $($config.PolicyTemplates.PSObject.Properties.Count) configured"
                      }
                      if ($config.EntraRoles) {
                          Write-Host "   Entra Roles: $($config.EntraRoles.PSObject.Properties.Count) configured"
                      }
                      if ($config.AzureResources) {
                          Write-Host "   Azure Resources: $($config.AzureResources.PSObject.Properties.Count) configured"
                      }
                  } else {
                      throw "Configuration is empty or null"
                  }
              }
              catch {
                  Write-Error "âŒ Key Vault access failed: $_"
                  Write-Host "ðŸ’¡ Possible issues:"
                  Write-Host "   - AZURE_KEY_VAULT_NAME secret not set correctly"
                  Write-Host "   - Key Vault permissions not configured"
                  Write-Host "   - Secret 'easypim-config-json' doesn't exist"
                  throw
              }
          }

          # Test 4: Microsoft Graph Connectivity & Authentication Bridge
          Write-Host ""
          Write-Host "ðŸŒ Test 4: Testing Microsoft Graph connectivity and authentication bridge..."
          try {
              # Test basic Graph connection using Azure CLI
              $tenantInfo = az rest --method GET --url "https://graph.microsoft.com/v1.0/organization" --query "value[0].{id:id,displayName:displayName}" 2>$null
              if ($tenantInfo) {
                  $tenant = $tenantInfo | ConvertFrom-Json
                  Write-Host "âœ… Microsoft Graph connectivity via Azure CLI verified"
                  Write-Host "   Tenant: $($tenant.displayName) ($($tenant.id))"
              } else {
                  Write-Warning "âš ï¸  Could not verify Graph connectivity via Azure CLI"
              }

              # Test the authentication bridge for EasyPIM (Graph PowerShell SDK)
              Write-Host ""
              Write-Host "ðŸ” Testing Graph PowerShell SDK authentication bridge..."

              # Get Microsoft Graph access token from Azure CLI
              $graphToken = az account get-access-token --resource https://graph.microsoft.com --query accessToken --output tsv

              if ($graphToken) {
                  Write-Host "âœ… Successfully obtained Microsoft Graph token from Azure CLI"

                  # Test connecting to Graph PowerShell SDK using the token
                  try {
                      $secureToken = ConvertTo-SecureString $graphToken -AsPlainText -Force
                      Connect-MgGraph -AccessToken $secureToken -NoWelcome

                      # Verify connection by getting current context
                      $context = Get-MgContext
                      if ($context) {
                          Write-Host "âœ… Microsoft Graph PowerShell SDK connection successful"
                          Write-Host "   Client ID: $($context.ClientId)"
                          Write-Host "   Tenant ID: $($context.TenantId)"
                          Write-Host "   Account: $($context.Account)"

                          # Test a basic Graph operation
                          try {
                              $profile = Get-MgOrganization -ErrorAction SilentlyContinue
                              if ($profile) {
                                  Write-Host "âœ… Graph API operations working correctly"
                              }
                          }
                          catch {
                              Write-Warning "âš ï¸  Graph API test failed: $_"
                          }

                          # Disconnect to clean up
                          Disconnect-MgGraph -ErrorAction SilentlyContinue
                      } else {
                          Write-Warning "âš ï¸  Graph PowerShell SDK connection failed - no context available"
                      }
                  }
                  catch {
                      Write-Warning "âš ï¸  Failed to connect to Graph PowerShell SDK: $_"
                      Write-Host "   This may indicate an authentication compatibility issue"
                  }
              } else {
                  Write-Error "âŒ Failed to obtain Microsoft Graph access token from Azure CLI"
                  Write-Host "   This may indicate insufficient permissions or authentication issues"
                  throw
              }
          }
          catch {
              Write-Warning "âš ï¸  Microsoft Graph authentication bridge test failed: $_"
              Write-Host "   This is critical for EasyPIM operations - check service principal permissions"
              Write-Host "   Required: RoleManagement.ReadWrite.Directory, Directory.Read.All"
              throw
          }

          # Test 5: Azure Resource Manager (ARM) Authentication
          Write-Host ""
          Write-Host "â˜ï¸ Test 5: Testing Azure Resource Manager authentication..."
          try {
              # Test Azure CLI is authenticated
              Write-Host "ðŸ” Testing Azure CLI authentication status..."
              $accountInfo = az account show --query "{name:name,id:id,tenantId:tenantId,user:user}" 2>$null
              if ($accountInfo) {
                  $account = $accountInfo | ConvertFrom-Json
                  Write-Host "âœ… Azure CLI authentication verified"
                  Write-Host "   Subscription: $($account.name) ($($account.id))"
                  Write-Host "   Tenant: $($account.tenantId)"
                  Write-Host "   User: $($account.user.name)"
              } else {
                  throw "Azure CLI not authenticated or subscription not accessible"
              }

              # Test Azure PowerShell authentication if available
              Write-Host ""
              Write-Host "ðŸ”§ Testing Azure PowerShell authentication..."
              try {
                  # Install Az.Accounts if not present
                  if (-not (Get-Module -ListAvailable -Name Az.Accounts)) {
                      Install-Module Az.Accounts -Force -Scope CurrentUser
                  }
                  Import-Module Az.Accounts -Force

                  # Test if already connected via enable-AzPSSession
                  $azContext = Get-AzContext -ErrorAction SilentlyContinue
                  if ($azContext) {
                      Write-Host "âœ… Azure PowerShell context already established"
                      Write-Host "   Account: $($azContext.Account.Id)"
                      Write-Host "   Subscription: $($azContext.Subscription.Name)"
                      Write-Host "   Tenant: $($azContext.Tenant.Id)"
                  } else {
                      Write-Host "âš ï¸  No Azure PowerShell context found"
                      Write-Host "   Note: This may be expected if enable-AzPSSession is not used"
                  }

                  # Test ARM REST API access
                  Write-Host ""
                  Write-Host "ðŸŒ Testing ARM REST API access..."
                  $subscriptionId = $env:SUBSCRIPTION_ID
                  $armToken = az account get-access-token --resource https://management.azure.com/ --query accessToken --output tsv

                  if ($armToken) {
                      Write-Host "âœ… ARM access token obtained successfully"

                      # Test a basic ARM operation - list resource groups
                      $resourceGroups = az group list --query "[].{name:name,location:location}" --output json 2>$null
                      if ($resourceGroups) {
                          $rgList = $resourceGroups | ConvertFrom-Json
                          Write-Host "âœ… ARM API operations working correctly"
                          Write-Host "   Resource Groups accessible: $($rgList.Count)"
                          if ($rgList.Count -gt 0) {
                              Write-Host "   Sample RG: $($rgList[0].name) ($($rgList[0].location))"
                          }
                      } else {
                          Write-Warning "âš ï¸  Could not list resource groups via ARM API"
                      }
                  } else {
                      throw "Failed to obtain ARM access token"
                  }

                  # Test Key Vault access via ARM (if Key Vault configured)
                  if ($env:KEYVAULT_NAME) {
                      Write-Host ""
                      Write-Host "ðŸ”‘ Testing Key Vault ARM access..."
                      $kvInfo = az keyvault show --name $env:KEYVAULT_NAME --query "{name:name,location:location,resourceGroup:resourceGroup}" 2>$null
                      if ($kvInfo) {
                          $kv = $kvInfo | ConvertFrom-Json
                          Write-Host "âœ… Key Vault ARM access verified"
                          Write-Host "   Key Vault: $($kv.name)"
                          Write-Host "   Location: $($kv.location)"
                          Write-Host "   Resource Group: $($kv.resourceGroup)"
                      } else {
                          Write-Warning "âš ï¸  Could not access Key Vault via ARM API"
                      }
                  }

              }
              catch {
                  Write-Warning "âš ï¸  Azure PowerShell context test failed: $_"
                  Write-Host "   This may be expected if Azure PowerShell is not required for your setup"
              }
          }
          catch {
              Write-Error "âŒ Azure Resource Manager authentication test failed: $_"
              Write-Host "ðŸ’¡ Possible issues:"
              Write-Host "   - OIDC authentication not properly configured"
              Write-Host "   - Service principal lacks subscription access"
              Write-Host "   - Azure CLI not authenticated to correct subscription"
              throw
          }

          # Test 6: EasyPIM Module Functions Available
          Write-Host ""
          Write-Host "ðŸ”§ Test 6: Verifying EasyPIM functions are available..."
          try {
              $commands = Get-Command -Module EasyPIM.Orchestrator
              Write-Host "âœ… EasyPIM.Orchestrator commands available: $($commands.Count)"
              $keyCommands = @('Invoke-EasyPIMOrchestrator', 'Test-PIMPolicyDrift')
              foreach ($cmd in $keyCommands) {
                  if (Get-Command $cmd -ErrorAction SilentlyContinue) {
                      Write-Host "   âœ… $cmd available"
                  } else {
                      Write-Warning "   âš ï¸  $cmd not found"
                  }
              }
          }
          catch {
              Write-Error "âŒ Failed to verify EasyPIM functions: $_"
              throw
          }

          Write-Host ""
          Write-Host "ðŸŽ‰ Phase 1 Authentication Test Complete!"
          Write-Host "============================================"
          Write-Host "All authentication components verified successfully."
          Write-Host "Ready to proceed to Phase 2: EasyPIM Operations"
          Write-Host ""
          Write-Host "âš ï¸  NOTE: This test does NOT execute EasyPIM operations."
          Write-Host "   Use Phase 2 workflow for actual PIM operations."

  generate-summary:
    name: 'Generate Summary'
    runs-on: ubuntu-latest
    needs: [authentication-test]
    if: always()

    steps:
      - name: 'Generate Workflow Summary'
        run: |
          echo "# ðŸ” Phase 1: Authentication Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Authentication Test results
          AUTH_STATUS="${{ needs.authentication-test.result }}"
          if [ "$AUTH_STATUS" = "success" ]; then
            echo "## âœ… Authentication Test: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "- All authentication components verified" >> $GITHUB_STEP_SUMMARY
            echo "- EasyPIM modules installed successfully" >> $GITHUB_STEP_SUMMARY
            echo "- Key Vault access confirmed" >> $GITHUB_STEP_SUMMARY
            echo "- Microsoft Graph connectivity verified" >> $GITHUB_STEP_SUMMARY
            echo "- Azure Resource Manager authentication verified" >> $GITHUB_STEP_SUMMARY
            echo "- EasyPIM functions available" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Authentication Test: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "- Authentication test failed" >> $GITHUB_STEP_SUMMARY
            echo "- Check logs for detailed error information" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ Phase 1 Purpose" >> $GITHUB_STEP_SUMMARY
          echo "This workflow only tests authentication components:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Module installation and import" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Azure OIDC authentication" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Key Vault access and configuration retrieval" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Microsoft Graph connectivity" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Azure Resource Manager (ARM) authentication" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… EasyPIM function availability" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”— Next Steps" >> $GITHUB_STEP_SUMMARY
          if [ "$AUTH_STATUS" = "success" ]; then
            echo "1. âœ… **Authentication verified** - Ready for Phase 2" >> $GITHUB_STEP_SUMMARY
            echo "2. ðŸš€ **Run Phase 2 workflow** for actual EasyPIM operations" >> $GITHUB_STEP_SUMMARY
          else
            echo "1. ðŸ“– **Review logs** for authentication component failures" >> $GITHUB_STEP_SUMMARY
            echo "2. ðŸ”§ **Check GitHub secrets** if Key Vault access failed" >> $GITHUB_STEP_SUMMARY
            echo "3. ðŸ”„ **Re-run Phase 1** after fixing issues" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“ Note**: No PIM operations are performed in Phase 1." >> $GITHUB_STEP_SUMMARY
