name: 'Phase 2: EasyPIM Orchestrator Test'

on:
  workflow_dispatch:
    inputs:
      WhatIf:
        description: "Preview mode - show what would be done without making changes"
        required: false
        default: true
        type: boolean
      Mode:
        description: "Orchestrator execution mode (delta=incremental, initial=destructive cleanup)"
        required: false
        default: "delta"
        type: choice
        options:
          - delta
          - initial
      SkipPolicies:
        description: "Skip policy operations (assignments only)"
        required: false
        default: false
        type: boolean
      SkipAssignments:
        description: "Skip assignment operations (policies only)"
        required: false
        default: false
        type: boolean
      Force:
        description: "Force execution (bypass confirmations)"
        required: false
        default: false
        type: boolean
      Verbose:
        description: "Enable verbose output"
        required: false
        default: false
        type: boolean
      ExportWouldRemove:
        description: "Export list of items that would be removed (audit purposes)"
        required: false
        default: false
        type: boolean

env:
  KEYVAULT_NAME: ${{ vars.AZURE_KEYVAULT_NAME }}
  SECRET_NAME: ${{ vars.AZURE_KEYVAULT_SECRET_NAME }}
  TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}

permissions:
  id-token: write   # for OIDC
  contents: read

jobs:
  easypim-orchestrator:
    name: 'EasyPIM Orchestrator Execution'
    runs-on: ubuntu-latest

    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      - name: 'Azure OIDC Login'
        uses: azure/login@v2
        with:
          tenant-id: ${{ env.TENANT_ID }}
          subscription-id: ${{ env.SUBSCRIPTION_ID }}
          client-id: ${{ env.AZURE_CLIENT_ID }}

      - name: 'Install and Run EasyPIM Orchestrator'
        shell: pwsh
        run: |
          Write-Host "ðŸš€ Installing EasyPIM modules from PowerShell Gallery..."

          # Install required modules from PowerShell Gallery
          Install-Module -Name EasyPIM -Force -Scope CurrentUser -Verbose
          Install-Module -Name EasyPIM.Orchestrator -Force -Scope CurrentUser -Verbose

          Write-Host "ðŸ“¦ Importing EasyPIM.Orchestrator module..."
          Import-Module EasyPIM.Orchestrator -Force -Verbose

          Write-Host "ðŸ” Setting up Microsoft Graph authentication using Azure CLI token..."
          
          # Get Microsoft Graph access token from Azure CLI (already authenticated via OIDC)
          $graphToken = az account get-access-token --resource https://graph.microsoft.com --query accessToken --output tsv
          
          if (-not $graphToken) {
              Write-Error "âŒ Failed to obtain Microsoft Graph access token from Azure CLI"
              exit 1
          }
          
          Write-Host "âœ… Successfully obtained Graph token, connecting to Microsoft Graph..."
          
          # Convert token to SecureString and connect to Microsoft Graph
          $secureToken = ConvertTo-SecureString $graphToken -AsPlainText -Force
          Connect-MgGraph -AccessToken $secureToken -NoWelcome
          
          Write-Host "âœ… Connected to Microsoft Graph successfully"

          # Determine execution parameters
          $whatIf = '${{ github.event.inputs.WhatIf }}' -eq 'true'
          $mode = if ('${{ github.event.inputs.Mode }}') { '${{ github.event.inputs.Mode }}' } else { 'delta' }
          $skipPolicies = '${{ github.event.inputs.SkipPolicies }}' -eq 'true'
          $skipAssignments = '${{ github.event.inputs.SkipAssignments }}' -eq 'true'
          $force = '${{ github.event.inputs.Force }}' -eq 'true'
          $verbose = '${{ github.event.inputs.Verbose }}' -eq 'true'
          $exportWouldRemove = '${{ github.event.inputs.ExportWouldRemove }}' -eq 'true'

          Write-Host "ðŸ”§ Execution Parameters:"
          Write-Host "   WhatIf: $whatIf"
          Write-Host "   Mode: $mode"
          Write-Host "   Skip Policies: $skipPolicies"
          Write-Host "   Skip Assignments: $skipAssignments"
          Write-Host "   Force: $force"
          Write-Host "   Verbose: $verbose"
          Write-Host "   Export WouldRemove: $exportWouldRemove"
          Write-Host "   Tenant ID: $env:TENANT_ID"
          Write-Host "   Subscription ID: $env:SUBSCRIPTION_ID"
          Write-Host "   Key Vault: $env:KEYVAULT_NAME"
          Write-Host "   Secret Name: $env:SECRET_NAME"

          # Build command parameters
          $orchestratorParams = @{
              'TenantId' = $env:TENANT_ID
              'SubscriptionId' = $env:SUBSCRIPTION_ID
              'Mode' = $mode
          }

          # Use Key Vault or local file
          if ($env:KEYVAULT_NAME) {
              Write-Host "ðŸ“‹ Using configuration from Key Vault: $env:KEYVAULT_NAME"
              $orchestratorParams['KeyVaultName'] = $env:KEYVAULT_NAME
              $orchestratorParams['SecretName'] = $env:SECRET_NAME
          } else {
              Write-Host "ðŸ“‹ Using local configuration file"
              $orchestratorParams['ConfigFilePath'] = "./configs/pim-config.json"
          }

          # Add conditional parameters
          if ($whatIf) {
              $orchestratorParams['WhatIf'] = $true
              Write-Host "âš ï¸  Running in PREVIEW mode (-WhatIf)"
          } else {
              Write-Host "ðŸš¨ Running in APPLY mode (changes will be made)"
          }

          if ($skipPolicies) {
              $orchestratorParams['SkipPolicies'] = $true
              Write-Host "â­ï¸  Skipping policy operations"
          }

          if ($skipAssignments) {
              $orchestratorParams['SkipAssignments'] = $true
              Write-Host "â­ï¸  Skipping assignment operations"
          }

          if ($force) {
              $orchestratorParams['Force'] = $true
              Write-Host "ðŸ’ª Force mode enabled (bypassing confirmations)"
          }

          if ($verbose) {
              $orchestratorParams['Verbose'] = $true
              Write-Host "ðŸ“ Verbose output enabled"
          }

          if ($exportWouldRemove) {
              $orchestratorParams['WouldRemoveExportPath'] = "./audit-exports"
              Write-Host "ðŸ“¤ WouldRemove export enabled (audit purposes)"
              # Ensure export directory exists
              New-Item -ItemType Directory -Path "./audit-exports" -Force | Out-Null
          }

          # Execute EasyPIM Orchestrator
          Write-Host "ðŸŽ¯ Executing: Invoke-EasyPIMOrchestrator"
          try {
              Invoke-EasyPIMOrchestrator @orchestratorParams
              Write-Host "âœ… EasyPIM Orchestrator completed successfully"
          }
          catch {
              Write-Error "âŒ EasyPIM Orchestrator failed: $_"
              throw
          }

      - name: 'Upload EasyPIM Logs'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: easypim-logs-${{ github.run_number }}
          path: |
            LOGS/*.log
            *.log
            audit-exports/*
          retention-days: 30

  policy-drift-check:
    name: 'Policy Drift Detection'
    runs-on: ubuntu-latest
    needs: easypim-orchestrator
    if: always() && !cancelled()

    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      - name: 'Azure OIDC Login'
        uses: azure/login@v2
        with:
          tenant-id: ${{ env.TENANT_ID }}
          subscription-id: ${{ env.SUBSCRIPTION_ID }}
          client-id: ${{ env.AZURE_CLIENT_ID }}

      - name: 'Test PIM Policy Drift'
        shell: pwsh
        run: |
          Write-Host "ðŸ” Installing EasyPIM modules for drift detection..."

          # Install required modules
          Install-Module -Name EasyPIM -Force -Scope CurrentUser
          Install-Module -Name EasyPIM.Orchestrator -Force -Scope CurrentUser
          Import-Module EasyPIM.Orchestrator -Force

          Write-Host "ðŸ” Running policy drift detection..."

          # Use Key Vault configuration (current workaround approach)
          # TODO: Future enhancement - when EasyPIM adds native AKV support for Test-PIMPolicyDrift,
          # we can simplify this to: Test-PIMPolicyDrift -KeyVaultName $env:KEYVAULT_NAME -SecretName $env:SECRET_NAME
          if ($env:KEYVAULT_NAME) {
              Write-Host "ðŸ“‹ Using configuration from Key Vault: $env:KEYVAULT_NAME"

              try {
                  # Get the configuration from Key Vault and save to temp file
                  # NOTE: Current implementation downloads config to temp file since Test-PIMPolicyDrift
                  # doesn't yet support KeyVault parameters directly. This will be simplified in future versions.
                  $configJson = az keyvault secret show --vault-name $env:KEYVAULT_NAME --name $env:SECRET_NAME --query "value" -o tsv
                  $tempConfigPath = "./temp-drift-config.json"
                  $configJson | Out-File -FilePath $tempConfigPath -Encoding UTF8

                  Write-Host "ðŸŽ¯ Executing Test-PIMPolicyDrift with parameters:"
                  Write-Host "   TenantId: $env:TENANT_ID"
                  Write-Host "   SubscriptionId: $env:SUBSCRIPTION_ID"
                  Write-Host "   ConfigPath: $tempConfigPath"

                  # Run drift detection with file (Test-PIMPolicyDrift doesn't support KeyVault params directly)
                  Test-PIMPolicyDrift -TenantId $env:TENANT_ID -SubscriptionId $env:SUBSCRIPTION_ID -ConfigPath $tempConfigPath

                  Write-Host "âœ… Policy drift check completed successfully"

                  # Clean up temp file
                  Remove-Item $tempConfigPath -ErrorAction SilentlyContinue
              }
              catch {
                  Write-Warning "âš ï¸  Policy drift check failed: $_"
                  Write-Host "ðŸ”§ Error details: $($_.Exception.Message)"
                  # Don't fail the workflow for drift check issues in this test phase
              }
          } else {
              Write-Host "ðŸ“‹ Using local configuration file"
              try {
                  Write-Host "ðŸŽ¯ Executing Test-PIMPolicyDrift with parameters:"
                  Write-Host "   TenantId: $env:TENANT_ID"
                  Write-Host "   SubscriptionId: $env:SUBSCRIPTION_ID"
                  Write-Host "   ConfigPath: ./configs/pim-config.json"

                  Test-PIMPolicyDrift -TenantId $env:TENANT_ID -SubscriptionId $env:SUBSCRIPTION_ID -ConfigPath "./configs/pim-config.json"
                  Write-Host "âœ… Policy drift check completed successfully"
              }
              catch {
                  Write-Warning "âš ï¸  Policy drift check failed: $_"
                  Write-Host "ðŸ”§ Error details: $($_.Exception.Message)"
              }
          }

  generate-summary:
    name: 'Generate Summary'
    runs-on: ubuntu-latest
    needs: [easypim-orchestrator, policy-drift-check]
    if: always()

    steps:
      - name: 'Generate Workflow Summary'
        run: |
          echo "# ðŸ§ª EasyPIM CI/CD Test Results - Phase 2" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Orchestrator results
          ORCHESTRATOR_STATUS="${{ needs.easypim-orchestrator.result }}"
          if [ "$ORCHESTRATOR_STATUS" = "success" ]; then
            echo "## âœ… EasyPIM Orchestrator: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "- Configuration processed successfully" >> $GITHUB_STEP_SUMMARY
            echo "- No errors encountered" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ EasyPIM Orchestrator: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "- Orchestrator execution failed" >> $GITHUB_STEP_SUMMARY
            echo "- Check logs for detailed error information" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Drift check results
          DRIFT_STATUS="${{ needs.policy-drift-check.result }}"
          if [ "$DRIFT_STATUS" = "success" ]; then
            echo "## âœ… Policy Drift Check: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "- Policy drift detection completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ Policy Drift Check: COMPLETED WITH WARNINGS" >> $GITHUB_STEP_SUMMARY
            echo "- Drift check may have found issues or warnings" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **WhatIf Mode**: ${{ github.event.inputs.WhatIf || 'true' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode**: ${{ github.event.inputs.Mode || 'delta' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip Policies**: ${{ github.event.inputs.SkipPolicies || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip Assignments**: ${{ github.event.inputs.SkipAssignments || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Force**: ${{ github.event.inputs.Force || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Verbose**: ${{ github.event.inputs.Verbose || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Export WouldRemove**: ${{ github.event.inputs.ExportWouldRemove || 'false' }}" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”— Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the uploaded logs for detailed execution information" >> $GITHUB_STEP_SUMMARY
          echo "2. Check policy drift results for any configuration discrepancies" >> $GITHUB_STEP_SUMMARY
          echo "3. If running in preview mode, consider applying changes by setting WhatIf=false" >> $GITHUB_STEP_SUMMARY
          echo "4. Review EasyPIM documentation for configuration guidance" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“ Note**: This is Phase 2 testing with actual EasyPIM operations." >> $GITHUB_STEP_SUMMARY
          echo "For authentication-only testing, use the Phase 1 workflow." >> $GITHUB_STEP_SUMMARY
