name: 'Phase 3: PIM Policy Drift Detection'

on:
  workflow_dispatch:
    inputs:
      Verbose:
        description: "Enable verbose output"
        required: false
        default: false
        type: boolean
  schedule:
    # Run daily at 6 AM UTC (optional automated drift detection)
    - cron: '0 6 * * *'

env:
  KEYVAULT_NAME: ${{ vars.AZURE_KEYVAULT_NAME }}
  SECRET_NAME: ${{ vars.AZURE_KEYVAULT_SECRET_NAME }}
  TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}

permissions:
  id-token: write   # for OIDC
  contents: read

jobs:
  policy-drift-check:
    name: 'Policy Drift Detection'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      - name: 'Azure OIDC Login'
        uses: azure/login@v2
        with:
          tenant-id: ${{ env.TENANT_ID }}
          subscription-id: ${{ env.SUBSCRIPTION_ID }}
          client-id: ${{ env.AZURE_CLIENT_ID }}
          enable-AzPSSession: true

      - name: 'Setup Authentication'
        shell: pwsh
        run: |
          $authResult = & "./scripts/workflows/Setup-EasyPIMAuthentication.ps1" -TenantId "$env:TENANT_ID" -SubscriptionId "$env:SUBSCRIPTION_ID" -ClientId "$env:AZURE_CLIENT_ID"
          if (-not $authResult) {
            Write-Error "âŒ Authentication setup failed"
            exit 1
          }

      - name: 'Install EasyPIM Modules'
        shell: pwsh
        run: |
          & "./scripts/workflows/Install-EasyPIMModules.ps1"

      - name: 'Configure Drift Detection Parameters'
        id: config
        shell: pwsh
        run: |
          Write-Host "ï¿½ Configuring drift detection parameters..." -ForegroundColor Cyan

          $verbose = '${{ github.event.inputs.Verbose }}' -eq 'true'

          if ($verbose) {
              Write-Host "ðŸ“ Verbose output enabled"
          }

          # Build drift detection parameters
          $driftParams = @{
              'TenantId' = $env:TENANT_ID
              'SubscriptionId' = $env:SUBSCRIPTION_ID
          }

          # Configuration source - check KeyVault native support first, fallback to temp file
          if ($env:KEYVAULT_NAME) {
              Write-Host "ðŸ“‹ Using configuration from Key Vault: $env:KEYVAULT_NAME" -ForegroundColor Green

              # Test native KeyVault support first - add both methods for compatibility
              $driftParams['KeyVaultName'] = $env:KEYVAULT_NAME
              $driftParams['SecretName'] = $env:SECRET_NAME

              # Also prepare temp file as fallback (will be removed once native support is confirmed)
              Write-Host "ðŸ”„ Also preparing temp file for compatibility..." -ForegroundColor Yellow
              $configJson = az keyvault secret show --vault-name $env:KEYVAULT_NAME --name $env:SECRET_NAME --query "value" -o tsv

              if ([string]::IsNullOrEmpty($configJson)) {
                  Write-Error "âŒ Failed to retrieve config from Key Vault - empty response"
                  exit 1
              }

              $tempConfigPath = "./temp-drift-config.json"
              $configJson | Out-File -FilePath $tempConfigPath -Encoding UTF8
              $driftParams['ConfigPath'] = $tempConfigPath

              Write-Host "âœ… Retrieved config successfully (Length: $($configJson.Length) chars)" -ForegroundColor Green
          } else {
              Write-Host "ðŸ“‹ Using local configuration file" -ForegroundColor Green
              $driftParams['ConfigPath'] = "./configs/pim-config.json"
          }

          # Add conditional parameters
          if ($verbose) {
              $driftParams['Verbose'] = $true
              Write-Host "ðŸ“ Verbose output enabled" -ForegroundColor Blue
          }

          Write-Host "ðŸŽ¯ Drift Detection Parameters:" -ForegroundColor Blue
          Write-Host "   TenantId: $env:TENANT_ID"
          Write-Host "   SubscriptionId: $env:SUBSCRIPTION_ID"
          if ($env:KEYVAULT_NAME) {
              Write-Host "   KeyVaultName: $env:KEYVAULT_NAME"
              Write-Host "   SecretName: $env:SECRET_NAME"
              Write-Host "   ConfigPath: $($driftParams['ConfigPath']) (fallback)"
          } else {
              Write-Host "   ConfigPath: $($driftParams['ConfigPath'])"
          }
          if ($verbose) {
              Write-Host "   Verbose: enabled"
          }

          # Store parameters as step output instead of environment variable
          $paramsJson = ($driftParams | ConvertTo-Json -Depth 3 -Compress)
          "drift-params=$paramsJson" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "âœ… Parameters configured successfully" -ForegroundColor Green

      - name: 'Execute Policy Drift Detection'
        id: drift_exec
        shell: pwsh
        run: |
          # Retrieve parameters from step output
          $driftParamsJson = '${{ steps.config.outputs.drift-params }}'
          Write-Host "ðŸ“¥ Retrieved parameters JSON: $($driftParamsJson.Substring(0, [Math]::Min(100, $driftParamsJson.Length)))..." -ForegroundColor Gray

          $driftParams = $driftParamsJson | ConvertFrom-Json -AsHashtable
          $graphContext = Get-MgContext

          # Execute using the dedicated script
          & "./scripts/workflows/Invoke-EasyPIMDriftDetection.ps1" -DriftParams $driftParams -GraphContext $graphContext

          # Clean up temp file if it was created
          if (Test-Path "./temp-drift-config.json") {
              Remove-Item "./temp-drift-config.json" -ErrorAction SilentlyContinue
              Write-Host "ðŸ§¹ Cleaned up temporary config file" -ForegroundColor Gray
          }

          # Surface drift summary to GitHub step outputs if present
          if (Test-Path './drift-summary.json') {
              $json = Get-Content './drift-summary.json' -Raw
              Write-Host "ðŸ“„ Drift summary JSON length: $($json.Length)"
              $parsed = $json | ConvertFrom-Json
              $driftCount = $parsed.driftCount
              $driftDetected = $parsed.driftDetected
              "drift-detected=$driftDetected" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
              "drift-count=$driftCount" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
              if ($parsed.drift -and $parsed.drift.Count -gt 0) {
                $first = ($parsed.drift | Select-Object -First 5 | ConvertTo-Json -Compress)
                "drift-sample=$first" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
              }
          } else {
              "drift-detected=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
              "drift-count=0" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      - name: 'Upload Drift Detection Results'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: policy-drift-results-${{ github.run_number }}
          path: |
            LOGS/*.log
            *.log
            drift-report.*
          retention-days: 30

      - name: 'Generate Workflow Summary'
        if: always()
        run: |
          echo "# ðŸ” PIM Policy Drift Detection Results - Phase 3" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          DRIFT_STATUS="${{ job.status }}"
          DRIFT_DETECTED="${{ steps.drift_exec.outputs.drift-detected }}"
          DRIFT_COUNT="${{ steps.drift_exec.outputs.drift-count }}"

          if [ "$DRIFT_STATUS" != "success" ]; then
            echo "## âŒ Policy Drift Detection Job Failed" >> $GITHUB_STEP_SUMMARY
            echo "- Execution error prevented drift evaluation" >> $GITHUB_STEP_SUMMARY
          else
            if [ "$DRIFT_DETECTED" = "true" ] && [ "$DRIFT_COUNT" != "0" ]; then
              echo "## âš ï¸ Drift Detected ($DRIFT_COUNT item(s))" >> $GITHUB_STEP_SUMMARY
              echo "- Policy drift identified in one or more items" >> $GITHUB_STEP_SUMMARY
              echo "- Review artifact: drift-summary.json" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Sample (first 5)" >> $GITHUB_STEP_SUMMARY
              echo '```json' >> $GITHUB_STEP_SUMMARY
              echo "${{ steps.drift_exec.outputs.drift-sample }}" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            else
              echo "## âœ… No Drift Detected" >> $GITHUB_STEP_SUMMARY
              echo "- All evaluated items match desired configuration" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Verbose**: ${{ github.event.inputs.Verbose || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Configuration Source**: ${{ vars.AZURE_KEYVAULT_NAME && 'Azure Key Vault' || 'Local File' }}" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”— Next Steps" >> $GITHUB_STEP_SUMMARY
          if [ "$DRIFT_STATUS" != "success" ]; then
            echo "1. ðŸ“‹ Review logs for execution error root cause" >> $GITHUB_STEP_SUMMARY
            echo "2. ï¿½ Re-run once issue addressed" >> $GITHUB_STEP_SUMMARY
          else
            if [ "$DRIFT_DETECTED" = "true" ] && [ "$DRIFT_COUNT" != "0" ]; then
              echo "1. âš¡ Run Phase 2 orchestrator to remediate drift" >> $GITHUB_STEP_SUMMARY
              echo "2. ï¿½ Validate remediation by re-running Phase 3" >> $GITHUB_STEP_SUMMARY
              echo "3. ðŸ—‚ï¸ Archive drift-summary.json for audit" >> $GITHUB_STEP_SUMMARY
            else
              echo "1. âœ… No action required - policies compliant" >> $GITHUB_STEP_SUMMARY
              echo "2. ï¿½ Maintain scheduled drift checks" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“ Note**: This is Phase 3 - dedicated policy drift detection." >> $GITHUB_STEP_SUMMARY
          echo "Use Phase 2 orchestrator workflow to apply configuration changes." >> $GITHUB_STEP_SUMMARY
