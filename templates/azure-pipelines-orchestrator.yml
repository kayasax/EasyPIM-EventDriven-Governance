# FIXED Azure Pipeline - Uses proper authentication methods for Azure DevOps
# This addresses the Azure CLI not being available in AzurePowerShell@5 tasks

trigger: none # Manual trigger only

parameters:
- name: serviceConnection
  displayName: 'Azure Service Connection'
  type: string
  default: 'EasyPIM-Azure-Connection'

- name: keyVaultName
  displayName: 'Key Vault Name'
  type: string
  default: 'default'

- name: run_description
  displayName: 'Custom description for this run (optional)'
  type: string
  default: 'EasyPIM Orchestrator Execution'

- name: configSecretName
  displayName: 'Key Vault secret name containing PIM configuration (optional)'
  type: string
  default: 'default'

- name: WhatIf
  displayName: 'Preview mode - show what would be done without making changes'
  type: boolean
  default: true

- name: Mode
  displayName: 'Orchestrator execution mode'
  type: string
  default: 'delta'
  values:
  - delta
  - initial

variables:
- group: EasyPIM-EventDriven-Governance
- name: KEYVAULT_NAME
  ${{ if ne(parameters.keyVaultName, 'default') }}:
    value: ${{ parameters.keyVaultName }}
  ${{ else }}:
    value: $(AZURE_KEY_VAULT_NAME)
- name: SECRET_NAME
  ${{ if ne(parameters.configSecretName, 'default') }}:
    value: ${{ parameters.configSecretName }}
  ${{ else }}:
    value: $(EASYPIM_SECRET_NAME)
- name: SERVICE_CONNECTION_NAME
  value: ${{ parameters.serviceConnection }}

pool: Default

name: EasyPIM_Orchestrator_$(Date:yyyyMMdd)_$(Rev:r)

stages:
- stage: Validation
  displayName: 'Pre-execution Validation'
  jobs:
  - job: ValidateInputs
    displayName: 'Validate Configuration'
    steps:
    - checkout: self
      displayName: 'Checkout Repository'

    - task: AzurePowerShell@5
      displayName: 'Validate EasyPIM Configuration'
      inputs:
        azureSubscription: $(SERVICE_CONNECTION_NAME)
        scriptType: 'inlineScript'
        azurePowerShellVersion: 'LatestVersion'
        pwsh: true
        inlineScript: |
          Write-Host "üîç Validating EasyPIM configuration..." -ForegroundColor Green

          # Determine secret name
          $secretName = "${{ parameters.configSecretName }}"
          if ([string]::IsNullOrEmpty($secretName) -or $secretName -eq "default") {
            $secretName = "$(EASYPIM_SECRET_NAME)"
          }

          # Determine Key Vault name
          $keyVaultName = "${{ parameters.keyVaultName }}"
          if ([string]::IsNullOrEmpty($keyVaultName) -or $keyVaultName -eq "default") {
            $keyVaultName = "$(AZURE_KEY_VAULT_NAME)"
          }

          Write-Host "üìã Using Key Vault: $keyVaultName" -ForegroundColor Cyan
          Write-Host "üìã Using configuration secret: $secretName" -ForegroundColor Cyan
          Write-Host "üéØ Execution mode: ${{ parameters.Mode }}" -ForegroundColor Cyan
          Write-Host "üîç What-If mode: ${{ parameters.WhatIf }}" -ForegroundColor Cyan

          # Test Azure PowerShell authentication
          Write-Host "üîê Testing Azure PowerShell authentication..." -ForegroundColor Cyan
          try {
            $context = Get-AzContext
            if ($context) {
              Write-Host "‚úÖ Azure PowerShell authenticated as: $($context.Account.Id)" -ForegroundColor Green
              Write-Host "     Subscription: $($context.Subscription.Name) ($($context.Subscription.Id))" -ForegroundColor Gray
              Write-Host "     Tenant: $($context.Tenant.Id)" -ForegroundColor Gray
            } else {
              throw "No Azure PowerShell context found"
            }
          } catch {
            Write-Host "‚ùå Azure PowerShell authentication failed: $($_.Exception.Message)" -ForegroundColor Red
            throw "Azure PowerShell authentication test failed"
          }

          # Test Key Vault access using Azure PowerShell
          Write-Host "üîç Testing Key Vault access..." -ForegroundColor Cyan
          try {
            # Get Key Vault information
            $keyVault = Get-AzKeyVault -VaultName $keyVaultName -ErrorAction Stop
            
            if ($keyVault) {
              Write-Host "‚úÖ Key Vault found: $($keyVault.VaultName)" -ForegroundColor Green
              Write-Host "     Location: $($keyVault.Location)" -ForegroundColor Gray
              Write-Host "     Resource Group: $($keyVault.ResourceGroupName)" -ForegroundColor Gray
            }

            # Test secret access
            Write-Host "üîë Attempting to access secret..." -ForegroundColor Cyan
            $secret = Get-AzKeyVaultSecret -VaultName $keyVaultName -Name $secretName -AsPlainText -ErrorAction Stop

            if ($secret) {
              Write-Host "‚úÖ Configuration secret accessible" -ForegroundColor Green
              Write-Host "     Secret length: $($secret.Length) characters" -ForegroundColor Gray
            } else {
              throw "Secret is null or empty"
            }
          } catch {
            Write-Host "‚ùå Key Vault access failed: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host "üìã Key Vault: $keyVaultName" -ForegroundColor Gray
            Write-Host "üìã Secret Name: $secretName" -ForegroundColor Gray
            
            # List available secrets for troubleshooting
            try {
              $secrets = Get-AzKeyVaultSecret -VaultName $keyVaultName -ErrorAction Stop
              if ($secrets) {
                Write-Host "üìã Available secrets:" -ForegroundColor Gray
                foreach ($s in $secrets) {
                  Write-Host "     - $($s.Name)" -ForegroundColor Gray
                }
              }
            } catch {
              Write-Host "‚ùå Cannot list Key Vault secrets" -ForegroundColor Red
            }
            
            throw "Key Vault validation failed"
          }

          Write-Host "‚úÖ Validation completed successfully!" -ForegroundColor Green

- stage: Execution
  displayName: 'EasyPIM Policy Execution'
  dependsOn: Validation
  condition: succeeded()
  jobs:
  - job: ExecuteOrchestrator
    displayName: 'Run EasyPIM Orchestrator'
    timeoutInMinutes: 30
    steps:
    - checkout: self
      displayName: 'Checkout Repository'

    # STEP 1: Install modules using AzurePowerShell task
    - task: AzurePowerShell@5
      displayName: 'Install Required Modules'
      inputs:
        azureSubscription: $(SERVICE_CONNECTION_NAME)
        scriptType: 'inlineScript'
        azurePowerShellVersion: 'LatestVersion'
        pwsh: true
        inlineScript: |
          Write-Host "üì¶ Installing required modules from PowerShell Gallery..." -ForegroundColor Green
          
          # Set PowerShell Gallery as trusted source
          Write-Host "üîß Configuring PowerShell Gallery..." -ForegroundColor Cyan
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          
          # Install EasyPIM module
          Write-Host "Installing EasyPIM.Orchestrator..." -ForegroundColor Cyan
          try {
            Install-Module -Name EasyPIM.Orchestrator -Force -Scope CurrentUser -AllowClobber -Verbose
            Write-Host "‚úÖ EasyPIM.Orchestrator installation completed" -ForegroundColor Green
          } catch {
            Write-Host "‚ùå Error installing EasyPIM.Orchestrator: $_" -ForegroundColor Red
            throw $_
          }
          
          # Install Microsoft Graph PowerShell modules
          Write-Host "Installing Microsoft Graph Authentication module..." -ForegroundColor Cyan
          try {
            Install-Module -Name Microsoft.Graph.Authentication -Force -Scope CurrentUser -AllowClobber -Verbose
            Write-Host "‚úÖ Microsoft.Graph.Authentication installation completed" -ForegroundColor Green
          } catch {
            Write-Host "‚ùå Error installing Microsoft.Graph.Authentication: $_" -ForegroundColor Red
            throw $_
          }
          
          # Verify installations
          Write-Host "üîç Verifying module installations..." -ForegroundColor Cyan
          $easyPIM = Get-Module -ListAvailable -Name EasyPIM.Orchestrator
          $graphAuth = Get-Module -ListAvailable -Name Microsoft.Graph.Authentication
          
          if ($easyPIM) {
            Write-Host "‚úÖ EasyPIM.Orchestrator found successfully" -ForegroundColor Green
            Write-Host "   Version: $($easyPIM.Version)" -ForegroundColor Gray
            Write-Host "   Path: $($easyPIM.ModuleBase)" -ForegroundColor Gray
          } else {
            Write-Host "‚ùå EasyPIM.Orchestrator module not found after installation" -ForegroundColor Red
            throw "EasyPIM.Orchestrator module verification failed"
          }
          
          if ($graphAuth) {
            Write-Host "‚úÖ Microsoft.Graph.Authentication found successfully" -ForegroundColor Green
            Write-Host "   Version: $($graphAuth.Version)" -ForegroundColor Gray
          } else {
            Write-Host "‚ùå Microsoft.Graph.Authentication module not found after installation" -ForegroundColor Red
            throw "Microsoft.Graph.Authentication module verification failed"
          }
          
          Write-Host "‚úÖ All modules installed and verified successfully!" -ForegroundColor Green

    # STEP 2: Get Graph token using Azure CLI task (separate task where Azure CLI is available)
    - task: AzureCLI@2
      displayName: 'Get Microsoft Graph Token'
      inputs:
        azureSubscription: $(SERVICE_CONNECTION_NAME)
        scriptType: 'pscore'
        scriptLocation: 'inlineScript'
        inlineScript: |
          Write-Host "üîê Getting Microsoft Graph access token via Azure CLI..." -ForegroundColor Cyan
          
          # Get Graph token using Azure CLI (this works in AzureCLI@2 task)
          $graphToken = az account get-access-token --resource https://graph.microsoft.com --query "accessToken" -o tsv
          
          if ($graphToken -and $graphToken -ne "null" -and $graphToken.Length -gt 100) {
            Write-Host "‚úÖ Microsoft Graph token acquired successfully" -ForegroundColor Green
            Write-Host "   Token length: $($graphToken.Length) characters" -ForegroundColor Gray
            
            # Save token to a file that the next task can read
            $graphToken | Out-File -FilePath "$(Agent.TempDirectory)/graph-token.txt" -Encoding UTF8 -NoNewline
            Write-Host "‚úÖ Token saved for next task" -ForegroundColor Green
          } else {
            Write-Host "‚ùå Failed to get Graph access token" -ForegroundColor Red
            throw "Microsoft Graph token acquisition failed"
          }

    # STEP 3: Execute EasyPIM using PowerShell task with the token
    - task: AzurePowerShell@5
      displayName: 'Execute EasyPIM Policy Orchestrator'
      inputs:
        azureSubscription: $(SERVICE_CONNECTION_NAME)
        scriptType: 'inlineScript'
        azurePowerShellVersion: 'LatestVersion'
        pwsh: true
        failOnStandardError: false
        inlineScript: |
          # Enable verbose output and error handling
          $VerbosePreference = "Continue"
          $ErrorActionPreference = "Continue"
          
          Write-Host "üöÄ Starting EasyPIM Policy Orchestrator execution..." -ForegroundColor Green
          Write-Host "‚è∞ Execution started at: $(Get-Date)" -ForegroundColor Gray

          # Import required modules
          Write-Host "üì¶ Importing required modules..." -ForegroundColor Cyan
          try {
            Import-Module EasyPIM.Orchestrator -Force -Verbose
            Import-Module Microsoft.Graph.Authentication -Force -Verbose
            Write-Host "‚úÖ Modules imported successfully" -ForegroundColor Green
          } catch {
            Write-Host "‚ùå Module import failed: $_" -ForegroundColor Red
            throw $_
          }
          
          # Verify Azure PowerShell context
          Write-Host "üîê Verifying Azure PowerShell context..." -ForegroundColor Cyan
          $context = Get-AzContext
          if ($context) {
            Write-Host "‚úÖ Azure PowerShell authenticated as: $($context.Account.Id)" -ForegroundColor Green
            Write-Host "     Subscription: $($context.Subscription.Name)" -ForegroundColor Gray
          } else {
            throw "No Azure PowerShell context found"
          }
          
          # Read Graph token from previous task
          Write-Host "üîê Reading Microsoft Graph token..." -ForegroundColor Cyan
          try {
            $graphToken = Get-Content -Path "$(Agent.TempDirectory)/graph-token.txt" -Raw
            if ($graphToken -and $graphToken.Length -gt 100) {
              Write-Host "‚úÖ Graph token loaded successfully" -ForegroundColor Green
              
              # Connect to Microsoft Graph using the token
              $secureToken = ConvertTo-SecureString $graphToken -AsPlainText -Force
              Connect-MgGraph -AccessToken $secureToken -NoWelcome
              
              $mgContext = Get-MgContext
              if ($mgContext) {
                Write-Host "‚úÖ Microsoft Graph authenticated successfully" -ForegroundColor Green
                Write-Host "   Account: $($mgContext.Account)" -ForegroundColor Gray
                Write-Host "   Scopes: $($mgContext.Scopes -join ', ')" -ForegroundColor Gray
              } else {
                Write-Host "‚ö†Ô∏è Microsoft Graph context is null after connection" -ForegroundColor Yellow
              }
            } else {
              throw "Invalid or missing Graph token"
            }
          } catch {
            Write-Host "‚ùå Microsoft Graph authentication failed: $_" -ForegroundColor Red
            Write-Host "üí° Continuing anyway - EasyPIM module may handle Graph auth internally" -ForegroundColor Yellow
          }

          # Set environment variables for EasyPIM module
          Write-Host "üîß Setting environment variables..." -ForegroundColor Cyan
          $env:AZURE_TENANT_ID = "$(AZURE_TENANT_ID)"
          $env:AZURE_SUBSCRIPTION_ID = "$(AZURE_SUBSCRIPTION_ID)"
          $env:AZURE_CLIENT_ID = "$(AZURE_CLIENT_ID)"
          
          Write-Host "   AZURE_TENANT_ID: $(AZURE_TENANT_ID)" -ForegroundColor Gray
          Write-Host "   AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)" -ForegroundColor Gray
          Write-Host "   AZURE_CLIENT_ID: $(AZURE_CLIENT_ID)" -ForegroundColor Gray

          # Determine parameters
          $secretName = "${{ parameters.configSecretName }}"
          if ([string]::IsNullOrEmpty($secretName) -or $secretName -eq "default") {
            $secretName = "$(SECRET_NAME)"
          }
          $keyVaultName = "${{ parameters.keyVaultName }}"
          if ([string]::IsNullOrEmpty($keyVaultName) -or $keyVaultName -eq "default") {
            $keyVaultName = "$(KEYVAULT_NAME)"
          }

          Write-Host "üìã Executing with parameters:" -ForegroundColor Cyan
          Write-Host "   KeyVaultName: $keyVaultName" -ForegroundColor Gray
          Write-Host "   SecretName: $secretName" -ForegroundColor Gray
          Write-Host "   WhatIf: ${{ parameters.WhatIf }}" -ForegroundColor Gray
          Write-Host "   Mode: ${{ parameters.Mode }}" -ForegroundColor Gray

          # Execute EasyPIM Orchestrator
          Write-Host "üéØ Starting EasyPIM Orchestrator execution..." -ForegroundColor Green
          try {
            # Convert parameters
            $whatIfParam = "${{ parameters.WhatIf }}"
            $whatIfMode = [System.Convert]::ToBoolean($whatIfParam)
            $executionMode = "${{ parameters.Mode }}"
            
            # Verify EasyPIM command exists
            $easyPIMCommand = Get-Command -Name "Invoke-EasyPIMOrchestrator" -ErrorAction SilentlyContinue
            if ($easyPIMCommand) {
              Write-Host "‚úÖ Invoke-EasyPIMOrchestrator command found" -ForegroundColor Green
            } else {
              Write-Host "‚ùå Invoke-EasyPIMOrchestrator command not found" -ForegroundColor Red
              Get-Command -Module EasyPIM.Orchestrator | ForEach-Object { Write-Host "   Available: $($_.Name)" -ForegroundColor Gray }
              throw "EasyPIM Orchestrator command not available"
            }
            
            # Execute EasyPIM
            Write-Host "üöÄ Executing Invoke-EasyPIMOrchestrator..." -ForegroundColor Green
            Invoke-EasyPIMOrchestrator -KeyVaultName $keyVaultName -SecretName $secretName -WhatIf:$whatIfMode -Mode $executionMode -Verbose

            Write-Host "‚úÖ EasyPIM execution completed successfully!" -ForegroundColor Green
            Write-Host "‚è∞ Execution completed at: $(Get-Date)" -ForegroundColor Gray
          } catch {
            Write-Host "‚ùå Error during EasyPIM execution: $_" -ForegroundColor Red
            Write-Host "Error details: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host "Stack trace: $($_.ScriptStackTrace)" -ForegroundColor Red
            throw $_
          }

  - job: GenerateReport
    displayName: 'Generate Execution Report'
    dependsOn: ExecuteOrchestrator
    condition: always()
    steps:
    - checkout: self
      displayName: 'Checkout Repository'

    - task: PowerShell@2
      displayName: 'Generate and Upload Report'
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "üìä Generating execution report..." -ForegroundColor Green

          # Create execution summary
          $reportPath = "execution-report-$(Get-Date -Format 'yyyyMMdd-HHmmss').json"

          $report = @{
            timestamp = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"
            pipeline = "$(Build.DefinitionName)"
            buildId = "$(Build.BuildId)"
            mode = "${{ parameters.Mode }}"
            whatIf = ${{ parameters.WhatIf }}
            configSecret = "$(SECRET_NAME)"
            keyVault = "$(KEYVAULT_NAME)"
            description = "${{ parameters.run_description }}"
            result = "$(Agent.JobStatus)"
          } | ConvertTo-Json -Depth 10

          $report | Out-File -FilePath $reportPath -Encoding UTF8

          Write-Host "üìã Report generated: $reportPath" -ForegroundColor Cyan
          Write-Host "üìÑ Report content:" -ForegroundColor Cyan
          Get-Content $reportPath

          Write-Host "‚úÖ Report generation completed!" -ForegroundColor Green

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Execution Report'
      inputs:
        pathToPublish: 'execution-report-*.json'
        artifactName: 'EasyPIM-Execution-Report'
        publishLocation: 'Container'
