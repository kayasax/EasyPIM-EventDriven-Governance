# Azure DevOps Pipeline for EasyPIM Event-Driven Governance
# This pipeline is triggered via REST API from the Azure Function when Key Vault secrets change

trigger: none  # Only triggered via API calls from Azure Function

parameters:
- name: configSecretName
  displayName: 'Configuration Secret Name'
  type: string
  default: 'easypim-config-ado'

- name: whatIfMode
  displayName: 'What-If Mode (Preview Only)'
  type: boolean
  default: false

- name: mode
  displayName: 'Execution Mode'
  type: string
  default: 'delta'
  values:
  - delta
  - initial

- name: verbose
  displayName: 'Verbose Output'
  type: boolean
  default: false

- name: runDescription
  displayName: 'Run Description'
  type: string
  default: 'Manual trigger'

- name: skipPolicies
  displayName: 'Skip Policies'
  type: boolean
  default: false

- name: skipAssignments
  displayName: 'Skip Assignments'
  type: boolean
  default: false

- name: allowProtectedRoles
  displayName: 'Allow Protected Roles'
  type: boolean
  default: false

variables:
  KEYVAULT_NAME: 'kv-easypim-8368'  # Update with your Key Vault name
  TENANT_ID: $(AZURE_TENANT_ID)           # Set in Azure DevOps variable groups
  SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID) # Set in Azure DevOps variable groups
  CLIENT_ID: $(AZURE_CLIENT_ID)           # Set in Azure DevOps variable groups

stages:
- stage: EasyPIMAuthentication
  displayName: 'ğŸ” Authentication & Setup'
  jobs:
  - job: AuthenticationTest
    displayName: 'Verify Authentication Chain'
    pool:
      vmImage: 'ubuntu-latest'
    
    steps:
    - checkout: self
      displayName: 'Checkout Repository'
      
    - task: AzurePowerShell@5
      displayName: 'ğŸ¯ Display Pipeline Parameters'
      inputs:
        azureSubscription: 'EasyPIM-ServiceConnection'  # Update with your service connection name
        ScriptType: 'InlineScript'
        Inline: |
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host "                    ğŸš€ EasyPIM Azure DevOps Pipeline" -ForegroundColor Cyan
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "ğŸ“‹ Pipeline Parameters:" -ForegroundColor Yellow
          Write-Host "  â€¢ Secret Name: ${{ parameters.configSecretName }}" -ForegroundColor White
          Write-Host "  â€¢ What-If Mode: ${{ parameters.whatIfMode }}" -ForegroundColor White
          Write-Host "  â€¢ Execution Mode: ${{ parameters.mode }}" -ForegroundColor White
          Write-Host "  â€¢ Verbose: ${{ parameters.verbose }}" -ForegroundColor White
          Write-Host "  â€¢ Skip Policies: ${{ parameters.skipPolicies }}" -ForegroundColor White
          Write-Host "  â€¢ Skip Assignments: ${{ parameters.skipAssignments }}" -ForegroundColor White
          Write-Host "  â€¢ Description: ${{ parameters.runDescription }}" -ForegroundColor White
          Write-Host ""
          Write-Host "âš™ï¸ Configuration:" -ForegroundColor Yellow
          Write-Host "  â€¢ Key Vault: $(KEYVAULT_NAME)" -ForegroundColor White
          Write-Host "  â€¢ Tenant ID: $(TENANT_ID)" -ForegroundColor White
          Write-Host "  â€¢ Subscription ID: $(SUBSCRIPTION_ID)" -ForegroundColor White
          Write-Host "  â€¢ Client ID: $(CLIENT_ID)" -ForegroundColor White
          Write-Host ""
        azurePowerShellVersion: 'LatestVersion'

    - task: AzurePowerShell@5
      displayName: 'ğŸ” Test Azure Authentication'
      inputs:
        azureSubscription: 'EasyPIM-ServiceConnection'
        ScriptType: 'InlineScript'
        Inline: |
          Write-Host "ğŸ” Verifying Azure authentication..." -ForegroundColor Yellow
          
          try {
            $context = Get-AzContext
            if ($context) {
              Write-Host "âœ… Azure PowerShell Authentication SUCCESS!" -ForegroundColor Green
              Write-Host "   Account: $($context.Account.Id)" -ForegroundColor White
              Write-Host "   Subscription: $($context.Subscription.Name)" -ForegroundColor White
              Write-Host "   Subscription ID: $($context.Subscription.Id)" -ForegroundColor White
              Write-Host "   Tenant ID: $($context.Tenant.Id)" -ForegroundColor White
            } else {
              Write-Host "âŒ Azure PowerShell Authentication FAILED!" -ForegroundColor Red
              exit 1
            }
          } catch {
            Write-Host "âŒ Azure authentication error: $($_.Exception.Message)" -ForegroundColor Red
            exit 1
          }
        azurePowerShellVersion: 'LatestVersion'

    - task: AzurePowerShell@5
      displayName: 'ğŸ”‘ Test Key Vault Access'
      inputs:
        azureSubscription: 'EasyPIM-ServiceConnection'
        ScriptType: 'InlineScript'
        Inline: |
          Write-Host "ğŸ”‘ Testing Key Vault access..." -ForegroundColor Yellow
          Write-Host "   Key Vault: $(KEYVAULT_NAME)" -ForegroundColor Cyan
          
          try {
            $secrets = Get-AzKeyVaultSecret -VaultName "$(KEYVAULT_NAME)" -ErrorAction Stop
            if ($secrets) {
              Write-Host "âœ… Key Vault access SUCCESS!" -ForegroundColor Green
              Write-Host "   Available secrets: $($secrets.Count)" -ForegroundColor White
            } else {
              Write-Host "âš ï¸ Key Vault accessible but no secrets found" -ForegroundColor Yellow
            }
          } catch {
            Write-Host "âŒ Key Vault access FAILED!" -ForegroundColor Red
            Write-Host "   Error: $($_.Exception.Message)" -ForegroundColor Red
            exit 1
          }
        azurePowerShellVersion: 'LatestVersion'

    - task: AzurePowerShell@5
      displayName: 'ğŸ“¦ Install EasyPIM Modules'
      inputs:
        azureSubscription: 'EasyPIM-ServiceConnection'
        ScriptType: 'InlineScript'
        Inline: |
          Write-Host "ğŸ“¦ Installing required PowerShell modules..." -ForegroundColor Yellow
          
          $modules = @(
            'Microsoft.Graph.Authentication',
            'EasyPIM.Orchestrator'
          )
          
          foreach ($module in $modules) {
            Write-Host "   Installing: $module" -ForegroundColor Cyan
            try {
              Install-Module -Name $module -Force -AllowClobber -Scope CurrentUser -Repository PSGallery -ErrorAction Stop
              Import-Module -Name $module -Force -ErrorAction Stop
              Write-Host "     âœ… $module installed successfully" -ForegroundColor Green
            } catch {
              Write-Host "     âŒ Failed to install $module`: $($_.Exception.Message)" -ForegroundColor Red
              exit 1
            }
          }
          
          Write-Host "âœ… PowerShell modules ready!" -ForegroundColor Green
        azurePowerShellVersion: 'LatestVersion'

- stage: EasyPIMExecution
  displayName: 'âš¡ EasyPIM Policy Orchestration'
  dependsOn: EasyPIMAuthentication
  condition: succeeded()
  jobs:
  - job: ExecuteEasyPIM
    displayName: 'Execute EasyPIM Orchestrator'
    pool:
      vmImage: 'ubuntu-latest'
    
    steps:
    - checkout: self
      displayName: 'Checkout Repository'

    - task: AzurePowerShell@5
      displayName: 'ğŸš€ Execute EasyPIM Orchestrator'
      inputs:
        azureSubscription: 'EasyPIM-ServiceConnection'
        ScriptType: 'InlineScript'
        Inline: |
          Write-Host "ğŸš€ Starting EasyPIM Orchestrator execution..." -ForegroundColor Cyan
          
          # Re-install modules (ADO doesn't persist between jobs)
          Write-Host "ğŸ“¦ Re-installing modules for execution..." -ForegroundColor Gray
          Install-Module -Name EasyPIM.Orchestrator -Force -AllowClobber -Scope CurrentUser -Repository PSGallery
          Install-Module -Name Microsoft.Graph.Authentication -Force -AllowClobber -Scope CurrentUser -Repository PSGallery
          Import-Module -Name EasyPIM.Orchestrator -Force
          Import-Module -Name Microsoft.Graph.Authentication -Force
          
          # Get Microsoft Graph token for EasyPIM
          Write-Host "ğŸ” Getting Microsoft Graph token..." -ForegroundColor Blue
          $graphToken = [Microsoft.Azure.Commands.Common.Authentication.AzureSession]::Instance.AuthenticationFactory.Authenticate($null, [Microsoft.Azure.Commands.Common.Authentication.Environment]::PublicEnvironments['AzureCloud'], 'https://graph.microsoft.com/', $null, 'Never', $null, 'https://graph.microsoft.com/').AccessToken
          
          if (-not $graphToken) {
            Write-Host "âŒ Failed to obtain Graph token" -ForegroundColor Red
            exit 1
          }
          
          # Connect to Microsoft Graph
          $secureToken = ConvertTo-SecureString $graphToken -AsPlainText -Force
          Connect-MgGraph -AccessToken $secureToken -NoWelcome
          Write-Host "âœ… Connected to Microsoft Graph" -ForegroundColor Green
          
          # Prepare EasyPIM parameters
          $easyPIMParams = @{
            KeyVaultName = "$(KEYVAULT_NAME)"
            SecretName = "${{ parameters.configSecretName }}"
            TenantId = "$(TENANT_ID)"
            WhatIf = [System.Convert]::ToBoolean("${{ parameters.whatIfMode }}")
            Mode = "${{ parameters.mode }}"
            Verbose = [System.Convert]::ToBoolean("${{ parameters.verbose }}")
          }
          
          if ([System.Convert]::ToBoolean("${{ parameters.skipPolicies }}")) {
            $easyPIMParams.SkipPolicies = $true
          }
          
          if ([System.Convert]::ToBoolean("${{ parameters.skipAssignments }}")) {
            $easyPIMParams.SkipAssignments = $true
          }
          
          Write-Host "ğŸ“‹ EasyPIM Execution Parameters:" -ForegroundColor Blue
          $easyPIMParams | ConvertTo-Json -Depth 2 | Write-Host
          
          try {
            Write-Host "âš¡ Executing EasyPIM Orchestrator..." -ForegroundColor Green
            
            # Execute EasyPIM (adjust command based on your EasyPIM module)
            $result = Invoke-EasyPIMOrchestrator @easyPIMParams
            
            Write-Host "âœ… EasyPIM execution completed successfully!" -ForegroundColor Green
            
            # Output results for pipeline summary
            if ($result) {
              Write-Host "ğŸ“Š Execution Results:" -ForegroundColor Cyan
              $result | ConvertTo-Json -Depth 3 | Write-Host
            }
            
          } catch {
            Write-Host "âŒ EasyPIM execution failed: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host "Full error details:" -ForegroundColor Red
            $_ | Format-List * -Force
            exit 1
          }
        azurePowerShellVersion: 'LatestVersion'
        workingDirectory: '$(System.DefaultWorkingDirectory)'

- stage: Summary
  displayName: 'ğŸ“Š Execution Summary'
  dependsOn: 
  - EasyPIMAuthentication
  - EasyPIMExecution
  condition: always()
  jobs:
  - job: GenerateSummary
    displayName: 'Generate Execution Summary'
    pool:
      vmImage: 'ubuntu-latest'
    
    steps:
    - task: PowerShell@2
      displayName: 'ğŸ“‹ Pipeline Summary'
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host "                    ğŸ“Š EasyPIM Pipeline Summary" -ForegroundColor Cyan
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          
          $authStatus = "$(Agent.JobStatus)"  # Status of authentication stage
          $execStatus = "$(Agent.JobStatus)"  # Status of execution stage
          
          Write-Host "ğŸ¯ Execution Overview:" -ForegroundColor Yellow
          Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Gray
          Write-Host "â”‚ Authentication              â”‚ âœ… COMPLETED   â”‚" -ForegroundColor Gray
          Write-Host "â”‚ EasyPIM Execution           â”‚ âœ… COMPLETED   â”‚" -ForegroundColor Gray
          Write-Host "â”‚ Configuration Secret        â”‚ ${{ parameters.configSecretName }}" -ForegroundColor Gray
          Write-Host "â”‚ Execution Mode              â”‚ ${{ parameters.mode }}" -ForegroundColor Gray
          Write-Host "â”‚ What-If Mode                â”‚ ${{ parameters.whatIfMode }}" -ForegroundColor Gray
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Gray
          Write-Host ""
          
          Write-Host "âš™ï¸ Pipeline Details:" -ForegroundColor Yellow
          Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Gray
          Write-Host "â”‚ Pipeline ID                 â”‚ $(System.DefinitionId)" -ForegroundColor Gray
          Write-Host "â”‚ Run Number                  â”‚ $(Build.BuildNumber)" -ForegroundColor Gray
          Write-Host "â”‚ Triggered by                â”‚ API (Event-Driven)" -ForegroundColor Gray
          Write-Host "â”‚ Repository                  â”‚ $(Build.Repository.Name)" -ForegroundColor Gray
          Write-Host "â”‚ Branch                      â”‚ $(Build.SourceBranchName)" -ForegroundColor Gray
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Gray
          Write-Host ""
          
          Write-Host "ğŸ‰ SUCCESS: EasyPIM governance pipeline completed!" -ForegroundColor Green
          Write-Host "   Your PIM policies have been processed via Azure DevOps." -ForegroundColor White
          Write-Host ""
          
          Write-Host "ğŸš€ Event-Driven Integration Active:" -ForegroundColor Yellow
          Write-Host "â€¢ Key Vault secret changes automatically trigger this pipeline" -ForegroundColor White
          Write-Host "â€¢ Intelligent parameter detection based on secret names" -ForegroundColor White
          Write-Host "â€¢ Complete audit trail maintained in Azure DevOps" -ForegroundColor White
          Write-Host "â€¢ Multi-platform support (GitHub Actions + Azure DevOps)" -ForegroundColor White
