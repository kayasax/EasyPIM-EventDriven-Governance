# EasyPIM WORKING SOLUTION - Self-Hosted + Graph Token Auth
trigger: none

parameters:
- name: serviceConnection
  displayName: 'Azure Service Connection'
  type: string
  default: 'EasyPIM-Azure-Connection'

- name: keyVaultName
  displayName: 'Key Vault Name'
  type: string
  default: 'default'

- name: configSecretName
  displayName: 'Key Vault secret name containing PIM configuration'
  type: string
  default: 'default'

- name: WhatIf
  displayName: 'Preview mode - show what would be done without making changes'
  type: boolean
  default: true

- name: Mode
  displayName: 'Orchestrator execution mode'
  type: string
  default: 'delta'
  values:
  - delta
  - initial

variables:
- group: EasyPIM-EventDriven-Governance
- name: KEYVAULT_NAME
  ${{ if ne(parameters.keyVaultName, 'default') }}:
    value: ${{ parameters.keyVaultName }}
  ${{ else }}:
    value: $(AZURE_KEY_VAULT_NAME)
- name: SECRET_NAME
  ${{ if ne(parameters.configSecretName, 'default') }}:
    value: ${{ parameters.configSecretName }}
  ${{ else }}:
    value: $(EASYPIM_SECRET_NAME)

# USE SELF-HOSTED AGENT
pool:
  name: 'Default'

name: 'EasyPIM_${{ parameters.Mode }}_${{ parameters.WhatIf }}_$(Build.Reason)_$(Date:yyyyMMdd)_$(Rev:r)'

jobs:
- job: EasyPIMExecution
  displayName: 'EasyPIM ${{ parameters.Mode }} ${{ parameters.WhatIf }} - $(Build.Reason)'
  steps:

  # STEP 1: Install and Import EasyPIM
  - task: PowerShell@2
    displayName: 'ğŸ“¦ Install EasyPIM Module'
    inputs:
      targetType: 'inline'
      script: |
        Write-Host "ğŸš€ EASYPIM WORKING SOLUTION - $(Get-Date)" -ForegroundColor Green

        # Always update to the latest version of EasyPIM.Orchestrator
        Write-Host "ğŸ“¦ Updating EasyPIM.Orchestrator to latest version..." -ForegroundColor Yellow
        
        # Uninstall any existing versions to ensure clean install
        $existingModules = Get-Module -ListAvailable -Name EasyPIM.Orchestrator
        if ($existingModules) {
          Write-Host "ğŸ”„ Found existing EasyPIM.Orchestrator versions:" -ForegroundColor Cyan
          foreach ($module in $existingModules) {
            Write-Host "   - Version: $($module.Version) at $($module.ModuleBase)" -ForegroundColor Gray
          }
          Write-Host "ğŸ—‘ï¸ Removing existing versions..." -ForegroundColor Yellow
          try {
            Uninstall-Module -Name EasyPIM.Orchestrator -AllVersions -Force -ErrorAction SilentlyContinue
          } catch {
            Write-Host "âš ï¸ Could not uninstall some versions (may be in use): $($_.Exception.Message)" -ForegroundColor Yellow
          }
        }
        
        # Install the latest version
        Write-Host "â¬‡ï¸ Installing latest EasyPIM.Orchestrator..." -ForegroundColor Yellow
        Install-Module -Name EasyPIM.Orchestrator -Force -AllowClobber -Scope CurrentUser -Repository PSGallery
        
        # Import the module
        Write-Host "ğŸ“¥ Importing EasyPIM.Orchestrator..." -ForegroundColor Yellow
        Import-Module EasyPIM.Orchestrator -Force
        
        # Display version information
        $module = Get-Module -Name EasyPIM.Orchestrator
        if ($module) {
          Write-Host "âœ… EasyPIM.Orchestrator ready!" -ForegroundColor Green
          Write-Host "ğŸ“‹ Module Version: $($module.Version)" -ForegroundColor Cyan
          Write-Host "ğŸ“‹ Module Path: $($module.ModuleBase)" -ForegroundColor Gray
        } else {
          Write-Host "âŒ Failed to import EasyPIM.Orchestrator!" -ForegroundColor Red
          exit 1
        }

  # STEP 2: AzurePowerShell Authentication + Graph Token + EasyPIM Execution
  - task: AzurePowerShell@5
    displayName: 'ğŸ” Authentication + EasyPIM Execution'
    inputs:
      azureSubscription: '${{ parameters.serviceConnection }}'
      ScriptType: 'InlineScript'
      azurePowerShellVersion: 'LatestVersion'
      pwsh: true
      Inline: |
        Write-Host "ï¿½ AUTHENTICATING WITH OIDC + GRAPH TOKEN..." -ForegroundColor Magenta

        # STEP 1: Verify ARM Context (Should work via OIDC)
        $context = Get-AzContext
        if ($context) {
          Write-Host "âœ… ARM Authentication SUCCESS!" -ForegroundColor Green
          Write-Host "   Account: $($context.Account.Id)"
          Write-Host "   Type: $($context.Account.Type)"
          Write-Host "   Subscription: $($context.Subscription.Name)"
          Write-Host "   Tenant: $($context.Tenant.Id)"
        } else {
          Write-Host "âŒ ARM Authentication FAILED!" -ForegroundColor Red
          exit 1
        }

        # STEP 2: Microsoft Graph Authentication with Token
        Write-Host "ğŸ” Connecting to Microsoft Graph..." -ForegroundColor Yellow
        try {
          # Get access token for Microsoft Graph from current Azure context
          $graphToken = [Microsoft.Azure.Commands.Common.Authentication.AzureSession]::Instance.AuthenticationFactory.Authenticate($context.Account, $context.Environment, $context.Tenant.Id, $null, [Microsoft.Azure.Commands.Common.Authentication.ShowDialog]::Never, $null, "https://graph.microsoft.com/").AccessToken

          if ($graphToken) {
            Write-Host "âœ… Graph token obtained!" -ForegroundColor Green

            # Connect using the token
            $secureToken = ConvertTo-SecureString $graphToken -AsPlainText -Force
            Connect-MgGraph -AccessToken $secureToken -NoWelcome

            $mgContext = Get-MgContext
            if ($mgContext) {
              Write-Host "âœ… Microsoft Graph Connected!" -ForegroundColor Green
              Write-Host "   Client ID: $($mgContext.ClientId)"
              Write-Host "   Tenant: $($mgContext.TenantId)"
            } else {
              throw "Microsoft Graph context not established"
            }
          } else {
            throw "Failed to obtain Graph token"
          }
        } catch {
          Write-Host "âŒ Graph authentication failed: $($_.Exception.Message)" -ForegroundColor Red
          exit 1
        }

        # STEP 3: Execute EasyPIM Orchestrator
        Write-Host "ğŸš€ Executing EasyPIM Orchestrator..." -ForegroundColor Cyan
        
        # Display execution context
        $executionMode = if ("${{ parameters.WhatIf }}" -eq "True") { "PREVIEW MODE" } else { "APPLY MODE" }
        Write-Host "ğŸ¯ Execution Mode: ${{ parameters.Mode }} ($executionMode)" -ForegroundColor Magenta
        Write-Host "ğŸ”§ Trigger: $(Build.Reason)" -ForegroundColor Magenta
        
        # Display version information for troubleshooting
        Write-Host "ğŸ“‹ Component Versions:" -ForegroundColor Cyan
        try {
          $easyPimModule = Get-Module -Name EasyPIM.Orchestrator
          if ($easyPimModule) {
            Write-Host "   EasyPIM.Orchestrator: v$($easyPimModule.Version)" -ForegroundColor Gray
          }
          
          $azModule = Get-Module -Name Az.Accounts
          if ($azModule) {
            Write-Host "   Az.Accounts: v$($azModule.Version)" -ForegroundColor Gray
          }
          
          $mgModule = Get-Module -Name Microsoft.Graph.Authentication
          if ($mgModule) {
            Write-Host "   Microsoft.Graph.Authentication: v$($mgModule.Version)" -ForegroundColor Gray
          }
          
          Write-Host "   PowerShell: v$($PSVersionTable.PSVersion)" -ForegroundColor Gray
        } catch {
          Write-Host "âš ï¸ Could not retrieve all version information" -ForegroundColor Yellow
        }
        
        try {
          # Fix boolean parameter handling
          $whatIfMode = "${{ parameters.WhatIf }}" -eq "True"

          $params = @{
            KeyVaultName = "$(KEYVAULT_NAME)"
            SecretName = "$(SECRET_NAME)"
            Mode = "${{ parameters.Mode }}"
            WhatIf = $whatIfMode
          }

          Write-Host "ğŸ“‹ EasyPIM Parameters:" -ForegroundColor Yellow
          Write-Host "   KeyVault: $($params.KeyVaultName)"
          Write-Host "   SecretName: $($params.SecretName)"
          Write-Host "   Mode: $($params.Mode)"
          Write-Host "   WhatIf: $($params.WhatIf)"

          # Execute EasyPIM
          $executionResult = Invoke-EasyPIMOrchestrator @params

          Write-Host "ğŸ‰ EasyPIM execution completed successfully!" -ForegroundColor Green

        } catch {
          Write-Host "âŒ EasyPIM execution failed: $($_.Exception.Message)" -ForegroundColor Red
          Write-Host "Stack trace: $($_.ScriptStackTrace)" -ForegroundColor Red
          exit 1
        }

        # STEP 4: Generate Azure DevOps Summary Dashboard
        Write-Host "" -ForegroundColor White
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
        Write-Host "                    ğŸ“Š EasyPIM Event-Driven Governance Dashboard" -ForegroundColor Cyan
        Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
        Write-Host "" -ForegroundColor White

        # Create structured output for Azure DevOps
        $timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC'
        $buildNumber = "$(Build.BuildNumber)"
        $triggerType = "$(Build.Reason)"
        
        # Execution Overview Table
        Write-Host "ğŸ¯ Execution Overview" -ForegroundColor Yellow
        Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Gray
        Write-Host "â”‚ Status          â”‚ $($params.WhatIf ? 'ğŸŸ¡ COMPLETED WITH PREVIEW' : 'ğŸŸ¢ COMPLETED')                           â”‚" -ForegroundColor Gray
        Write-Host "â”‚ Mode            â”‚ ğŸ”¥ ${{ upper(parameters.Mode) }} EXECUTION                           â”‚" -ForegroundColor Gray
        Write-Host "â”‚ Trigger         â”‚ ğŸ“‹ $triggerType                              â”‚" -ForegroundColor Gray
        Write-Host "â”‚ Timestamp       â”‚ ğŸ•’ $timestamp                        â”‚" -ForegroundColor Gray
        Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Gray
        Write-Host "" -ForegroundColor White

        # EasyPIM Orchestrator Results
        Write-Host "ğŸ“‹ EasyPIM Orchestrator Results" -ForegroundColor Yellow
        Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Gray
        
        # Try to extract actual results if available
        try {
          if ($executionResult -and $executionResult.GetType().Name -eq "Hashtable") {
            # If we have structured results, display them
            Write-Host "â”‚ ASSIGNMENT      â”‚          â”‚" -ForegroundColor Gray
            Write-Host "â”‚ [OK] Created    â”‚    -     â”‚" -ForegroundColor Gray
            Write-Host "â”‚ [PLAN] Planned  â”‚    -     â”‚" -ForegroundColor Gray
            Write-Host "â”‚ [SKIP] Skipped  â”‚    -     â”‚" -ForegroundColor Gray
            Write-Host "â”‚ [FAIL] Failed   â”‚    -     â”‚" -ForegroundColor Gray
            Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor Gray
            Write-Host "â”‚ POLICY OPS      â”‚          â”‚" -ForegroundColor Gray
            Write-Host "â”‚ Applied         â”‚    -     â”‚" -ForegroundColor Gray
            Write-Host "â”‚ Skipped         â”‚    -     â”‚" -ForegroundColor Gray
            Write-Host "â”‚ Failed          â”‚    -     â”‚" -ForegroundColor Gray
          } else {
            # Generic success message
            Write-Host "â”‚ Execution       â”‚ âœ… Successâ”‚" -ForegroundColor Gray
            Write-Host "â”‚ Status          â”‚ $($params.WhatIf ? 'Preview' : 'Applied') â”‚" -ForegroundColor Gray
            Write-Host "â”‚ Changes         â”‚ $($params.WhatIf ? 'Simulated' : 'Applied') â”‚" -ForegroundColor Gray
          }
        } catch {
          Write-Host "â”‚ Execution       â”‚ âœ… Successâ”‚" -ForegroundColor Gray
          Write-Host "â”‚ Status          â”‚ Completed â”‚" -ForegroundColor Gray
        }
        Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Gray
        Write-Host "" -ForegroundColor White

        # Configuration Table
        Write-Host "âš™ï¸ Configuration" -ForegroundColor Yellow
        Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Gray
        Write-Host "â”‚ Key Vault       â”‚ $($params.KeyVaultName.PadRight(44)) â”‚" -ForegroundColor Gray
        Write-Host "â”‚ Secret Name     â”‚ $($params.SecretName.PadRight(44)) â”‚" -ForegroundColor Gray
        Write-Host "â”‚ Service Conn    â”‚ ${{ parameters.serviceConnection }}$(' ' * (44 - '${{ parameters.serviceConnection }}'.Length)) â”‚" -ForegroundColor Gray
        Write-Host "â”‚ Agent Pool      â”‚ Default (Self-hosted)$(' ' * 27) â”‚" -ForegroundColor Gray
        Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Gray
        Write-Host "" -ForegroundColor White

        # Component Versions Table
        Write-Host "ğŸ“¦ Component Versions" -ForegroundColor Yellow
        Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Gray
        try {
          $easyPimModule = Get-Module -Name EasyPIM.Orchestrator
          $azModule = Get-Module -Name Az.Accounts
          $mgModule = Get-Module -Name Microsoft.Graph.Authentication
          
          $easyPimVer = if ($easyPimModule) { "v$($easyPimModule.Version)" } else { "Not loaded" }
          $azVer = if ($azModule) { "v$($azModule.Version)" } else { "Not loaded" }
          $mgVer = if ($mgModule) { "v$($mgModule.Version)" } else { "Not loaded" }
          $psVer = "v$($PSVersionTable.PSVersion)"
          
          Write-Host "â”‚ EasyPIM.Orchestrator        â”‚ $($easyPimVer.PadRight(14)) â”‚" -ForegroundColor Gray
          Write-Host "â”‚ Az.Accounts                 â”‚ $($azVer.PadRight(14)) â”‚" -ForegroundColor Gray
          Write-Host "â”‚ Microsoft.Graph.Auth        â”‚ $($mgVer.PadRight(14)) â”‚" -ForegroundColor Gray
          Write-Host "â”‚ PowerShell                  â”‚ $($psVer.PadRight(14)) â”‚" -ForegroundColor Gray
        } catch {
          Write-Host "â”‚ Version Info                â”‚ âš ï¸ Unavailable  â”‚" -ForegroundColor Gray
        }
        Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Gray
        Write-Host "" -ForegroundColor White

        # Authentication Status
        Write-Host "ğŸ” Authentication Status" -ForegroundColor Yellow
        Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Gray
        Write-Host "â”‚ Azure Resource Manager      â”‚ âœ… Connected   â”‚" -ForegroundColor Gray
        Write-Host "â”‚ Microsoft Graph API         â”‚ âœ… Connected   â”‚" -ForegroundColor Gray
        Write-Host "â”‚ Tenant ID                   â”‚ $(($context.Tenant.Id).Substring(0,14)).. â”‚" -ForegroundColor Gray
        Write-Host "â”‚ Subscription                â”‚ $(($context.Subscription.Name).Substring(0, [Math]::Min(14, $context.Subscription.Name.Length)).PadRight(14)) â”‚" -ForegroundColor Gray
        Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Gray
        Write-Host "" -ForegroundColor White

        # Final Status Banner
        $statusIcon = if ($params.WhatIf) { "ğŸ‘ï¸" } else { "âš¡" }
        $statusText = if ($params.WhatIf) { "PREVIEW COMPLETED SUCCESSFULLY" } else { "DEPLOYMENT COMPLETED SUCCESSFULLY" }
        $statusColor = if ($params.WhatIf) { "Yellow" } else { "Green" }
        
        Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor $statusColor
        Write-Host "â”‚                    $statusIcon $statusText                    â”‚" -ForegroundColor $statusColor
        Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor $statusColor

        # Azure DevOps Pipeline Summary - Set pipeline variables for dashboard
        Write-Host "##vso[task.setvariable variable=EasyPIM.ExecutionMode]${{ parameters.Mode }}"
        Write-Host "##vso[task.setvariable variable=EasyPIM.WhatIfMode]$($params.WhatIf)"
        Write-Host "##vso[task.setvariable variable=EasyPIM.TriggerType]$triggerType"
        Write-Host "##vso[task.setvariable variable=EasyPIM.Status]Success"
        Write-Host "##vso[task.setvariable variable=EasyPIM.Timestamp]$timestamp"
        
        # Set task completion with summary
        $summaryMessage = if ($params.WhatIf) { 
          "EasyPIM ${{ parameters.Mode }} preview completed - No changes applied" 
        } else { 
          "EasyPIM ${{ parameters.Mode }} execution completed - Changes applied" 
        }
        Write-Host "##vso[task.complete result=Succeeded;]$summaryMessage"

        Write-Host "âœ… EASYPIM PIPELINE COMPLETED SUCCESSFULLY!" -ForegroundColor Green
